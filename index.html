<!-- /index.html  v3.0  --> 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Portfolio Dashboard ‚Äì Lofty2304</title>

  <!-- libs -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/talib-web@1.0.2/dist/talib.min.js"></script>

  <link rel="manifest" href="manifest.json"/>
  <style>/*  --- theme & layout CSS (unchanged from v2 for brevity) ---  */</style>
</head>
<body>
<div id="app"><!-- rendered at runtime --></div>

<script type="module">
/* -----------------------------------------------------------------
   0. CONFIG
------------------------------------------------------------------ */
const FUNDS = {
  DSP_HC_DIR:  {name:'DSP Healthcare',       isin:'INF740K01GB9'},
  HDFC_GOLD_DIR:{name:'HDFC Gold FoF',       isin:'INF179K01WN1'},
  HDFC_N500_DIR:{name:'HDFC Nifty500',       isin:'INF179KC1BT8'},
  PP_CONS_DIR:  {name:'PP Conservative',     isin:'INF879O01AE4'},
  PP_FLEXI_DIR: {name:'PP Flexi Cap',        isin:'INF879O01AT9'},
  MO_ELSS_DIR:  {name:'MO ELSS',             isin:'INF247L01AF4'},
  MO_SMALL_DIR: {name:'MO Small Cap',        isin:'INF247L01536'},
  INV_PAN_EUR_DIR:{name:'Invesco Pan Europe',isin:'INF205K01WG4'},
  AXIS_GLOBAL_DIR:{name:'Axis Global Eq',    isin:'INF846K01BP7'},
  FRANKLIN_US_DIR:{name:'Franklin US Opp',   isin:'INF082K01636'}
};

const TARGET = {
  LargeCap: 18, Flexi:15, SmallMid:10, Gold:10,
  Hybrid:10, Sector:<15, Intl:12, ELSS:5
};

const SIP_CALENDAR = { weekly:7, fortnight:15, monthly:30 };

/* -----------------------------------------------------------------
   1. UTILITIES
------------------------------------------------------------------ */
const $ = sel=>document.querySelector(sel);
const fmt = v=>'‚Çπ'+(+v).toLocaleString('en-IN',{maximumFractionDigits:0});
const pct = v=>`${v>0?'+':''}${v.toFixed(2)}%`;

async function json(url,opts){return fetch(url,opts).then(r=>r.json());}
async function text(url){return fetch(url).then(r=>r.text());}

/* -----------------------------------------------------------------
   2. DATA FETCHERS
------------------------------------------------------------------ */
// a) Daily NAV from AMFI (CSV) ------------------------------------------------
async function fetchNAV(isin){
  const raw = await text(`https://api.mfapi.in/isin/${isin}`);
  const j   = JSON.parse(raw);
  return +j.data[0].nav;                 // latest nav float
}

// b) Currency rates ----------------------------------------------------------
async function fx(pair){                 // e.g. 'USD'
  const j=await json(`https://open.er-api.com/v6/latest/${pair}`);
  return j.rates.INR;
}

// c) Sentiment scores (Reddit + X) ------------------------------------------
async function sentiment(q){
  const key='YOUR_RAPIDAPI_KEY';
  const hdr={headers:{'X-RapidAPI-Key':key,'X-RapidAPI-Host':'socialsentiment.p.rapidapi.com'}};
  const r = await json(`https://socialsentiment.p.rapidapi.com/v1/search?query=${q}`,hdr);
  return r.overallScore||0;
}

/* -----------------------------------------------------------------
   3. TECH + FORECAST
------------------------------------------------------------------ */
async function technical(isin){
  const hist = await json(`https://api.mfapi.in/series/${isin}?days=120`);
  const closes = hist.data.map(d=>+d.nav).reverse();
  const rsi = talib.RSI(closes,14).pop();
  const sma20 = talib.SMA(closes,20).pop();
  const sma50 = talib.SMA(closes,50).pop();
  return {rsi,sma20,sma50,latest:closes.at(-1)};
}

async function forecast(series){
  // minimal tfjs LSTM single-step forecast (12 epochs, small model cached)
  const seq   = tf.tensor(series).reshape([1,series.length,1]).div(series[0]);
  const model = await tf.loadLayersModel('https://lofty2304.github.io/models/nav-lstm/model.json');
  const pred  = model.predict(seq).dataSync()[0];
  return pred*series[0];
}

/* -----------------------------------------------------------------
   4. SIP OPTIMISER
------------------------------------------------------------------ */
function bestDay(last12){                // list of 12 monthly NAV arrays
  // Choose date with lowest average nav (calendar effect)
  const map = new Map();                 // day -> [values]
  last12.forEach(month=>{
    month.forEach(d=>{
      const day=d.date.slice(8,10);
      map.set(day,(map.get(day)||[]).concat(+d.nav));
    });
  });
  const arr=[...map.entries()].map(([day,vals])=>[day,vals.reduce((a,b)=>a+b)/vals.length]);
  arr.sort((a,b)=>a[1]-b[1]);
  return +arr[0][0];                     // best calendar day (lowest avg nav)
}

function freqDecision(vol, sentimentScore){
  if(vol>15)    return 'weekly';
  if(vol>10)    return sentimentScore>0?'fortnight':'weekly';
  return 'monthly';
}

/* -----------------------------------------------------------------
   5. MAIN DASHBOARD RENDER
------------------------------------------------------------------ */
async function main(){
  // 1) NAV + metrics ---------------------------------------------------------
  const cards = $('#app');
  cards.innerHTML=`<h2>Loading Portfolio‚Ä¶</h2>`;
  const navs = {};
  for(const [k,v] of Object.entries(FUNDS)) navs[k]=await fetchNAV(v.isin);

  // 2) currency --------------------------------------------------------------
  const usd = await fx('USD'), eur = await fx('EUR');

  // 3) sentiment + technical per fund ---------------------------------------
  const fundRows=[];
  for(const [code,f] of Object.entries(FUNDS)){
    const tech = await technical(f.isin);
    const sent = await sentiment(f.name.split(' ')[0]);     // coarse query
    const last12 = await json(`https://api.mfapi.in/series/${f.isin}?months=12`);
    const optDay = bestDay(last12.data);
    const freq   = freqDecision(tech.rsi, sent);
    fundRows.push({code,name:f.name,nav:navs[code],rsi:tech.rsi.toFixed(1),
       optDay,freq,sent:sent.toFixed(0)});
  }

  // 4) build table -----------------------------------------------------------
  cards.innerHTML=`
  <h1 style="margin:0 0 20px">üß† AI-Optimised SIP Scheduler</h1>
  <table border=0 cellpadding=8 style="width:100%;border-collapse:collapse">
    <thead><tr style="background:#f0f4ff">
      <th>Fund</th><th>NAV</th><th>RSI</th><th>Sentiment</th>
      <th>Suggested SIP Day</th><th>Frequency</th></tr></thead>
    <tbody>${fundRows.map(r=>`
      <tr><td>${r.name}</td><td>${r.nav}</td><td>${r.rsi}</td>
      <td>${r.sent}%</td><td>${r.optDay}</td><td>${r.freq}</td></tr>`).join('')}
    </tbody>
  </table>
  <p style="margin-top:20px;font-size:.9em">
    ‚Ä¢ Frequencies: weekly (7 d) | fortnight (15 d) | monthly (30 d).<br>
    ‚Ä¢ Suggested day = historical lowest average NAV day over last 12 months.
  </p>
  <hr>
  <h2>üåê FX Monitor</h2>
  <p>USD/INR ${usd.toFixed(2)}   EUR/INR ${eur.toFixed(2)} 
     ${eur>=92?'<span style="color:#e00">‚Üí Invesco exit trigger</span>':''}</p>
  `;
}
main();
</script>
</body>
</html>
